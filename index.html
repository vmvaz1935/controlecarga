<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACWR ‚Ä¢ sRPE Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
     <!-- Configura√ß√£o H√≠brida (Local + Online) -->
   <script>
     // Detectar ambiente
     const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
     const BACKEND_URL = isLocal ? 'http://localhost:5000' : null;
     
     const FIREBASE_CONFIG = {
       "apiKey":"AIzaSyDXp03zlG1SlbWVbwtGbYjVuO3HmmTF8og",
       "authDomain":"app-controle-de-carga-d7aab.firebaseapp.com",
       "projectId":"app-controle-de-carga-d7aab",
       "storageBucket":"app-controle-de-carga-d7aab.firebasestorage.app",
       "messagingSenderId":"862654831012",
       "appId":"1:862654831012:web:cd46334c80d2ce17a40931",
       "measurementId":"G-3V589Q63DE"
     };
   </script>
  <style>
    :root { 
      --bg: #f8fafc; 
      --card: #ffffff; 
      --primary: #3b82f6; 
      --primary-dark: #2563eb;
      --primary-light: #dbeafe;
      --muted: #64748b; 
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      background: linear-gradient(135deg, var(--bg) 0%, #e2e8f0 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      margin: 0;
      min-height: 100vh;
    }
    
    .card { 
      background: var(--card); 
      border-radius: 1.5rem; 
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .chip { 
      padding: 0.5rem 1rem; 
      border-radius: 999px; 
      background: var(--primary-light); 
      color: var(--primary-dark); 
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .chip:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.05);
    }
    
    .kpi { 
      font-size: 2rem; 
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-label { 
      font-size: 0.875rem; 
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .btn { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff; 
      padding: 0.75rem 1.5rem; 
      border-radius: 1rem; 
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-secondary { 
      background: #f1f5f9; 
      color: #475569;
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .btn-ghost { 
      background: transparent; 
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-ghost:hover {
      background: var(--primary);
      color: white;
    }
    
    .small { 
      font-size: 0.875rem; 
      color: var(--muted);
      line-height: 1.5;
    }
    
    .calendar-grid { 
      display: grid; 
      grid-template-columns: repeat(7, minmax(0, 1fr)); 
      gap: 0.5rem; 
    }
    
    .calendar-cell { 
      min-height: 80px; 
      border-radius: 1rem; 
      background: #fff; 
      position: relative; 
      padding: 0.75rem;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    
    .calendar-cell:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }
    
    .calendar-load { 
      position: absolute; 
      inset: 0; 
      border-radius: 1rem; 
      opacity: 0.15;
      transition: opacity 0.3s ease;
    }
    
    /* Inputs modernos */
    input, textarea, select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 1rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Anima√ß√µes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.4s ease-out;
    }
    
    /* Status indicators */
    .status-low { color: var(--success); }
    .status-sweet { color: var(--warning); }
    .status-high { color: var(--danger); }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      .card { border-radius: 1rem; }
      .btn { padding: 0.625rem 1.25rem; font-size: 0.8rem; }
      .kpi { font-size: 1.5rem; }
      .calendar-cell { min-height: 60px; padding: 0.5rem; }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="p-4 md:p-6 fade-in">
    <div class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">AC</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">ACWR ‚Ä¢ sRPE Dashboard</h1>
          <p class="text-sm text-gray-500 -mt-1">Controle inteligente de carga de treinamento</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="seedBtn" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
          <span>üéØ</span> Demo
        </button>
        <button id="exportBtn" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
          <span>üì§</span> Exportar
        </button>
        <label class="btn-secondary px-3 py-2 rounded-lg cursor-pointer flex items-center gap-2">
          <span>üì•</span> Importar
          <input id="importInput" type="file" accept=".csv" class="hidden" />
        </label>
        <button id="clearBtn" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
          <span>üóëÔ∏è</span> Limpar
        </button>
      </div>
    </div>
  </header>

  <main class="p-4 md:p-6">
    <div class="max-w-6xl mx-auto grid md:grid-cols-5 gap-6">
             <!-- Left: Auth + Form -->
       <section class="md:col-span-2 card p-6 space-y-6 fade-in">
         <div>
           <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
             <span>‚òÅÔ∏è</span> Sincroniza√ß√£o em Nuvem
           </h2>
           <p class="small mb-3">Conecte-se ao Firebase para sincronizar seus dados automaticamente.</p>
           
           <div id="authBox" class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
             <div class="flex flex-wrap items-center gap-2 mb-3">
               <span class="small">üë§ Usu√°rio:</span>
               <span id="userSpan" class="text-sm font-medium">‚Äî</span>
               <button id="googleBtn" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
                 <span>üîê</span> Google
               </button>
               <button id="signOutBtn" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
                 <span>üö™</span> Sair
               </button>
             </div>
             <details class="mt-3">
               <summary class="cursor-pointer text-sm font-medium flex items-center gap-2">
                 <span>üìß</span> Entrar com E-mail/Senha
               </summary>
               <div class="grid grid-cols-2 gap-2 mt-3">
                 <input id="emailInput" type="email" placeholder="email@exemplo.com" class="border rounded-lg p-2 col-span-2">
                 <input id="passInput" type="password" placeholder="Senha" class="border rounded-lg p-2 col-span-2">
                 <button id="emailSignIn" class="btn-secondary px-3 py-2 rounded-lg">Entrar</button>
                 <button id="emailSignUp" class="btn-secondary px-3 py-2 rounded-lg">Criar conta</button>
                 <button id="emailReset" class="btn-secondary px-3 py-2 rounded-lg col-span-2">Esqueci a senha</button>
               </div>
             </details>
             <div class="mt-3 small">üÜî UID: <b id="uidSpan">‚Äî</b></div>
             <div class="mt-3 flex flex-wrap gap-2">
               <button id="cloudPull" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
                 <span>‚¨áÔ∏è</span> Carregar
               </button>
               <button id="cloudPush" class="btn-secondary px-3 py-2 rounded-lg flex items-center gap-2">
                 <span>‚¨ÜÔ∏è</span> Salvar
               </button>
               <label class="flex items-center gap-2 text-sm">
                 <input id="autoSync" type="checkbox" /> üîÑ Auto-sync
               </label>
             </div>
             <div class="mt-3 flex items-center gap-2">
               <span id="cloudStatus" class="small px-3 py-1 bg-green-100 text-green-800 rounded-full">Conectado</span>
               <span class="text-xs text-gray-500">Firebase configurado automaticamente</span>
             </div>
           </div>
         </div>

         <div class="h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>

        <h2 class="text-lg font-semibold flex items-center gap-2">
          <span>‚ûï</span> Nova Sess√£o
        </h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="small font-medium">üìÖ Data</label>
            <input id="dateInput" type="date" class="w-full border rounded-lg p-3" />
          </div>
          <div class="col-span-2">
            <label class="small font-medium">üèÉ Nome da sess√£o</label>
            <input id="nameInput" type="text" placeholder="Corrida Intervalada, For√ßa Lower..." class="w-full border rounded-lg p-3" />
          </div>
          <div>
            <label class="small font-medium">‚è±Ô∏è Dura√ß√£o (min)</label>
            <input id="durInput" type="number" min="0" class="w-full border rounded-lg p-3" placeholder="60" />
          </div>
          <div>
            <label class="small font-medium">üí™ RPE (0‚Äì10)</label>
            <input id="rpeInput" type="number" min="0" max="10" class="w-full border rounded-lg p-3" placeholder="6" />
            <div class="flex flex-wrap gap-2 mt-2">
              <span class="chip cursor-pointer" data-rpe="3">3</span>
              <span class="chip cursor-pointer" data-rpe="4">4</span>
              <span class="chip cursor-pointer" data-rpe="5">5</span>
              <span class="chip cursor-pointer" data-rpe="6">6</span>
              <span class="chip cursor-pointer" data-rpe="7">7</span>
            </div>
          </div>
          <div class="col-span-2">
            <button id="addBtn" class="btn w-full flex items-center justify-center gap-2">
              <span>‚ûï</span> Adicionar sess√£o
            </button>
          </div>
        </div>

        <div class="h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>

        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <span>üìã</span> Entradas recentes
        </h3>
        <div class="max-h-64 overflow-auto">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-white">
              <tr class="text-left text-gray-500 border-b">
                <th class="py-2">Data</th>
                <th>Dia</th>
                <th>Nome</th>
                <th class="text-right">Min</th>
                <th class="text-right">RPE</th>
                <th class="text-right">sRPE</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="entriesTbody"></tbody>
          </table>
        </div>
        <p class="small mt-3">üí° sRPE = Dura√ß√£o √ó RPE. Dados ficam no <b>localStorage</b> e podem ser <b>sincronizados</b> com o <b>Firestore</b>.</p>
      </section>

      <!-- Right: Dashboard -->
      <section class="md:col-span-3 card p-6 fade-in">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
          <h2 class="text-lg font-semibold flex items-center gap-2">
            <span>üìä</span> Painel de Controle
          </h2>
          <div class="flex items-center gap-2">
            <label class="small font-medium">üìÖ Per√≠odo:</label>
            <input id="fromInput" type="date" class="border rounded-lg p-2" />
            <span class="text-gray-400">‚Äî</span>
            <input id="toInput" type="date" class="border rounded-lg p-2" />
            <button id="applyRangeBtn" class="btn-ghost px-3 py-2 rounded-lg">Aplicar</button>
          </div>
        </div>

        <div class="grid md:grid-cols-5 gap-4 mb-6">
          <div class="p-4 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
            <div class="kpi" id="kpiAcute">0</div>
            <div class="kpi-label">Carga Aguda (7d)</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
            <div class="kpi" id="kpiChronic">0</div>
            <div class="kpi-label">Carga Cr√¥nica (28d)</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200">
            <div class="kpi" id="kpiACWR">‚Äî</div>
            <div class="kpi-label">ACWR</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-200">
            <div class="kpi" id="kpiStatus">‚Äî</div>
            <div class="kpi-label">Zona</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200">
            <div class="kpi" id="kpiDaily">0</div>
            <div class="kpi-label">Carga do dia (sRPE)</div>
          </div>
        </div>

        <div class="card p-4 mb-6">
          <canvas id="acwrChart" height="120"></canvas>
          <p class="small mt-3 text-center">üìà Linha: ACWR ‚Ä¢ Barras: Aguda (7d) e Cr√¥nica (28d). LOW &lt; 0,8 | SWEET 0,8‚Äì1,3 | HIGH &gt; 1,3.</p>
        </div>

        <div>
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <span>üìÖ</span> Vis√£o mensal
            </h3>
            <div class="flex items-center gap-2">
              <button id="prevMonth" class="btn-secondary px-3 py-2 rounded-lg">‚óÄ</button>
              <div id="monthLabel" class="min-w-28 text-center font-medium"></div>
              <button id="nextMonth" class="btn-secondary px-3 py-2 rounded-lg">‚ñ∂</button>
            </div>
          </div>
          <div class="grid grid-cols-7 mb-2 text-xs text-gray-500 font-medium">
            <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div><div>Dom</div>
          </div>
          <div id="calendar" class="calendar-grid"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="p-6 text-center small">
    üöÄ Pronto para GitHub Pages e Canva (Embed). Ative os provedores em Authentication e autorize seu dom√≠nio.
  </footer>

<script>
// ---------- Firebase H√≠brido (Local + Online) ----------
let fb = { app:null, auth:null, db:null, uid:null, user:null, connected:false, idToken:null, useBackend: false };

async function connectFirebase(){
  const statusElement = document.getElementById("cloudStatus");
  
  try { 
    // Verificar se Firebase est√° dispon√≠vel
    if (typeof firebase === 'undefined') {
      throw new Error("Firebase n√£o carregado");
    }
    
    // Inicializar Firebase
    fb.app = firebase.initializeApp(FIREBASE_CONFIG);
    fb.auth = firebase.auth();
    
    // Verificar se backend est√° dispon√≠vel
    if (BACKEND_URL) {
      try {
        const response = await fetch(`${BACKEND_URL}/api/health`, { timeout: 3000 });
        if (response.ok) {
          fb.useBackend = true;
          statusElement.textContent = "Conectado (Backend)";
          showNotification("Backend conectado com sucesso!", "success");
        }
      } catch (e) {
        console.log("Backend n√£o dispon√≠vel, usando Firebase direto");
        fb.useBackend = false;
        fb.db = firebase.firestore();
        statusElement.textContent = "Conectado (Firebase)";
        showNotification("Firebase conectado com sucesso!", "success");
      }
    } else {
      // Online - usar Firebase direto
      fb.useBackend = false;
      fb.db = firebase.firestore();
      statusElement.textContent = "Conectado (Online)";
      showNotification("Firebase conectado com sucesso!", "success");
    }
    
    statusElement.className = "small px-3 py-1 bg-green-100 text-green-800 rounded-full";
    fb.connected = true;
    
    fb.auth.onAuthStateChanged(async (user) => {
      fb.user = user || null;
      fb.uid = user ? user.uid : null;
      
      if (user) {
        if (fb.useBackend) {
          fb.idToken = await user.getIdToken();
        }
        document.getElementById("uidSpan").textContent = fb.uid || "‚Äî";
        document.getElementById("userSpan").textContent = user.email || user.displayName || user.uid;
        showNotification(`Bem-vindo, ${user.email || user.displayName}!`, "success");
      } else {
        fb.idToken = null;
        document.getElementById("uidSpan").textContent = "‚Äî";
        document.getElementById("userSpan").textContent = "‚Äî";
      }
    });
  } catch (e) {
    statusElement.textContent = "Erro de conex√£o";
    statusElement.className = "small px-3 py-1 bg-red-100 text-red-800 rounded-full";
    fb.connected = false;
    showNotification("Falha ao conectar Firebase.", "error");
  }
}

async function pullFromCloud(){
  const pullBtn = document.getElementById("cloudPull");
  addLoadingState(pullBtn);
  
  try {
    if (!fb.uid) {
      throw new Error("Usu√°rio n√£o autenticado");
    }
    
    if (fb.useBackend && fb.idToken) {
      // Usar backend
      const response = await fetch(`${BACKEND_URL}/api/sessions/${fb.uid}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${fb.idToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`Erro ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      saveLocal(data.sessions || []); 
      showNotification(`${data.count} sess√µes carregadas do cloud!`, "success");
    } else {
      // Usar Firebase direto
      const snap = await fb.db.collection("users").doc(fb.uid).collection("sessions").get();
      const arr = []; 
      snap.forEach(doc => arr.push({ ...doc.data(), id: doc.id }));
      saveLocal(arr); 
      showNotification(`${arr.length} sess√µes carregadas do cloud!`, "success");
    }
    
    boot();
  } catch (error) {
    showNotification("Erro ao carregar dados do cloud: " + error.message, "error");
  } finally {
    removeLoadingState(pullBtn);
  }
}

async function pushToCloud(){
  const pushBtn = document.getElementById("cloudPush");
  addLoadingState(pushBtn);
  
  try {
    if (!fb.uid) {
      throw new Error("Usu√°rio n√£o autenticado");
    }
    
    const arr = loadLocal();
    
    if (fb.useBackend && fb.idToken) {
      // Usar backend
      const response = await fetch(`${BACKEND_URL}/api/sessions/${fb.uid}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${fb.idToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sessions: arr })
      });
      
      if (!response.ok) {
        throw new Error(`Erro ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      showNotification(`${data.count} sess√µes sincronizadas com o cloud!`, "success");
    } else {
      // Usar Firebase direto
      const batch = fb.db.batch();
      const col = fb.db.collection("users").doc(fb.uid).collection("sessions");
      const snap = await col.get(); 
      snap.forEach(doc => batch.delete(doc.ref));
      arr.forEach(s => batch.set(col.doc(s.id), { date: s.date, name: s.name, duration: s.duration, rpe: s.rpe }));
      await batch.commit(); 
      showNotification(`${arr.length} sess√µes sincronizadas com o cloud!`, "success");
    }
  } catch (error) {
    showNotification("Erro ao sincronizar com o cloud: " + error.message, "error");
  } finally {
    removeLoadingState(pushBtn);
  }
}

// ---------- Auth ----------
 async function googleSignIn(){
   const googleBtn = document.getElementById("googleBtn");
   addLoadingState(googleBtn);
   
   const provider = new firebase.auth.GoogleAuthProvider();
   provider.addScope('email');
   provider.addScope('profile');
   
   try { 
     await fb.auth.signInWithPopup(provider); 
     showNotification("Login com Google realizado com sucesso!", "success");
   }
   catch (e) { 
     console.error("Erro no login Google:", e);
     
     if (e.code === "auth/popup-blocked") { 
       showNotification("Popup bloqueado. Tentando redirecionamento...", "info");
       try {
         await fb.auth.signInWithRedirect(provider);
       } catch (redirectError) {
         showNotification("Erro no redirecionamento: " + redirectError.message, "error");
       }
     } else if (e.code === "auth/unauthorized-domain") {
       showNotification("Dom√≠nio n√£o autorizado. Configure no Firebase Console.", "error");
     } else if (e.code === "auth/operation-not-allowed") {
       showNotification("Login Google n√£o habilitado. Configure no Firebase Console.", "error");
     } else { 
       showNotification("Falha no login Google: " + e.message, "error"); 
     } 
   } finally {
     removeLoadingState(googleBtn);
   }
 }

async function emailSignIn(email, pass){ 
  const signInBtn = document.getElementById("emailSignIn");
  addLoadingState(signInBtn);
  
  try { 
    await fb.auth.signInWithEmailAndPassword(email, pass); 
    showNotification("Login realizado com sucesso!", "success");
  } catch (e) { 
    showNotification("Erro no login: " + e.message, "error"); 
  } finally {
    removeLoadingState(signInBtn);
  }
}

async function emailSignUp(email, pass){ 
  const signUpBtn = document.getElementById("emailSignUp");
  addLoadingState(signUpBtn);
  
  try { 
    await fb.auth.createUserWithEmailAndPassword(email, pass); 
    showNotification("Conta criada com sucesso!", "success");
  } catch (e) { 
    showNotification("Erro ao criar conta: " + e.message, "error"); 
  } finally {
    removeLoadingState(signUpBtn);
  }
}

async function emailReset(email){ 
  const resetBtn = document.getElementById("emailReset");
  addLoadingState(resetBtn);
  
  try { 
    await fb.auth.sendPasswordResetEmail(email); 
    showNotification("E-mail de redefini√ß√£o enviado!", "success");
  } catch (e) { 
    showNotification("Erro ao enviar e-mail: " + e.message, "error"); 
  } finally {
    removeLoadingState(resetBtn);
  }
}

async function signOut(){ 
  try { 
    await fb.auth.signOut(); 
    showNotification("Logout realizado com sucesso!", "info");
  } catch(e){
    showNotification("Erro ao fazer logout.", "error");
  } 
}

// ---------- Core ----------
const KEY = "acwr_sessions_v1";
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const fmt = (n) => Number(n || 0).toLocaleString('pt-BR', { maximumFractionDigits: 1 });

function toISODate(d) { return d.toISOString().slice(0,10); }
function parseISO(s) { const [y,m,da] = s.split('-').map(Number); return new Date(y, m-1, da); }
function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function mondayOf(date) { const d = new Date(date); const day = (d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; }

function loadLocal(){ try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ return []; } }
function saveLocal(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

function sRPE(session){ return Number(session.duration||0) * Number(session.rpe||0); }
function buildDailySeries(sessions){
  const map = new Map();
  sessions.forEach(s => { if(!s.date) return; const key = s.date; map.set(key, (map.get(key)||0) + sRPE(s)); });
  const dates = Array.from(map.keys()).sort();
  return dates.map(d => ({ date: d, load: map.get(d) }));
}
function rollingSum(series, windowDays, idx){
  const end = parseISO(series[idx].date);
  const start = addDays(end, -(windowDays-1));
  let sum = 0;
  for(let i=0;i<=idx;i++){ const dt = parseISO(series[i].date); if(dt>=start && dt<=end) sum += series[i].load; }
  return sum;
}
function rollingAvg(series, windowDays, idx){
  const end = parseISO(series[idx].date);
  const start = addDays(end, -(windowDays-1));
  let sum = 0, count = 0;
  for(let i=0;i<=idx;i++){ const dt = parseISO(series[i].date); if(dt>=start && dt<=end){ sum+=series[i].load; count++; } }
  return count>0 ? (sum/windowDays) : 0;
}
function computeTimeSeries(sessions){
  const daily = buildDailySeries(sessions);
  return daily.map((d, i) => {
    const acute = rollingSum(daily, 7, i);
    const chronic = rollingAvg(daily, 28, i) * 7;
    const acwr = chronic>0 ? (acute/chronic) : 0;
    return { ...d, acute, chronic, acwr };
  });
}
function statusFromACWR(x){ 
  if(!x || !isFinite(x)) return "‚Äî"; 
  if(x < 0.8) return "LOW"; 
  if(x <= 1.3) return "SWEET"; 
  return "HIGH"; 
}

function getStatusClass(status) {
  switch(status) {
    case "LOW": return "status-low";
    case "SWEET": return "status-sweet";
    case "HIGH": return "status-high";
    default: return "";
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-50 fade-in ${
    type === 'success' ? 'bg-green-500' : 
    type === 'error' ? 'bg-red-500' : 
    'bg-blue-500'
  }`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

function addLoadingState(element) {
  element.classList.add('loading');
  element.disabled = true;
}

function removeLoadingState(element) {
  element.classList.remove('loading');
  element.disabled = false;
}

function renderEntriesTable(sessions){
  const tbody = $("#entriesTbody"); 
  tbody.innerHTML = "";
  const sorted = sessions.slice().sort((a,b)=> a.date.localeCompare(b.date)).reverse();
  
  if (sorted.length === 0) {
    const emptyRow = document.createElement("tr");
    emptyRow.innerHTML = `
      <td colspan="7" class="text-center py-8 text-gray-500">
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">üìù</span>
          <span>Nenhuma sess√£o registrada</span>
          <span class="text-sm">Adicione sua primeira sess√£o acima</span>
        </div>
      </td>`;
    tbody.appendChild(emptyRow);
    return;
  }
  
  sorted.forEach((s, index) => {
    const dow = ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"][(parseISO(s.date).getDay()+6)%7];
    const tr = document.createElement("tr");
    tr.className = "fade-in";
    tr.style.animationDelay = `${index * 0.1}s`;
    tr.innerHTML = `
      <td class="py-2 font-medium">${s.date||""}</td>
      <td class="text-gray-600">${dow||""}</td>
      <td class="font-medium">${s.name||""}</td>
      <td class="text-right font-medium">${s.duration||""} min</td>
      <td class="text-right">
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          ${s.rpe||""}
        </span>
      </td>
      <td class="text-right font-bold text-blue-600">${fmt(sRPE(s))}</td>
      <td class="text-right">
        <button class="text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition-colors" data-del="${s.id}" title="Remover sess√£o">
          üóëÔ∏è
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
  
  $$("button[data-del]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-del");
      const session = sessions.find(s => s.id === id);
      
      if (confirm(`Remover sess√£o "${session?.name || 'Sem nome'}" de ${session?.date}?`)) {
        try {
      const next = loadLocal().filter(s => s.id !== id);
      saveLocal(next);
          
          if($("#autoSync").checked && fb.uid) { 
            try { 
              await pushToCloud(); 
              showNotification("Sess√£o removida e sincronizada!", "success");
            } catch(e){
              showNotification("Sess√£o removida localmente. Erro na sincroniza√ß√£o.", "error");
            }
          } else {
            showNotification("Sess√£o removida com sucesso!", "success");
          }
          
      boot();
        } catch (error) {
          showNotification("Erro ao remover sess√£o.", "error");
        }
      }
    });
  });
}

let chart;
function renderKPIsAndChart(sessions, fromDate=null, toDate=null){
  let filtered = sessions.slice();
  if(fromDate) filtered = filtered.filter(s => s.date >= fromDate);
  if(toDate) filtered = filtered.filter(s => s.date <= toDate);

  const ts = computeTimeSeries(filtered);
  const last = ts[ts.length-1];
  $("#kpiAcute").textContent = last ? fmt(last.acute) : "0";
  $("#kpiChronic").textContent = last ? fmt(last.chronic) : "0";
  $("#kpiACWR").textContent = last ? fmt(last.acwr) : "‚Äî";
  $("#kpiDaily").textContent = (filtered.length && last) ? fmt(filtered.filter(s=>s.date===last.date).reduce((a,b)=>a+(b.duration*b.rpe),0)) : "0";

  const status = statusFromACWR(last?.acwr);
  const statusElement = $("#kpiStatus");
  statusElement.textContent = status;
  statusElement.className = `kpi ${getStatusClass(status)}`;

  const labels = ts.map(d=>d.date);
  const acute = ts.map(d=>d.acute);
  const chronic = ts.map(d=>d.chronic);
  const acwr = ts.map(d=>d.acwr);

  const ctx = document.getElementById("acwrChart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { type:"bar", label:"Aguda (7d)", data: acute, borderWidth:0, backgroundColor:"rgba(37,99,235,.35)" },
        { type:"bar", label:"Cr√¥nica (28d)", data: chronic, borderWidth:0, backgroundColor:"rgba(16,185,129,.35)" },
        { type:"line", label:"ACWR", data: acwr, yAxisID:"y1", borderWidth:2, tension:.2, pointRadius:2, borderColor:"#111827" }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero:true, title:{display:true, text:"Carga (sRPE)"} }, y1: { beginAtZero:true, position:"right", title:{display:true, text:"ACWR"} } },
      plugins: { legend: { display: true } }
    }
  });
}

let calRef = new Date();
function renderCalendar(sessions){
  const grid = document.getElementById("calendar"); 
  grid.innerHTML = "";
  const y = calRef.getFullYear(), m = calRef.getMonth();
  const first = new Date(y, m, 1);
  const monthName = first.toLocaleDateString("pt-BR", { month:"long", year:"numeric" });
  document.getElementById("monthLabel").textContent = monthName[0].toUpperCase()+monthName.slice(1);

  const start = mondayOf(first);
  for(let i=0;i<42;i++){ 
    const day = addDays(start, i); 
    const iso = toISODate(day); 
    const sameMonth = (day.getMonth()===m);
    const load = loadLocal().filter(s=>s.date===iso).reduce((a,b)=>a+(b.duration*b.rpe),0);
    const isToday = iso === toISODate(new Date());
    
    const cell = document.createElement("div"); 
    cell.className = `calendar-cell border transition-all duration-200 ${sameMonth ? "" : "opacity-30"} ${isToday ? "ring-2 ring-blue-500 ring-opacity-50" : ""}`;
    
    const label = document.createElement("div"); 
    label.className = `text-xs font-medium ${isToday ? "text-blue-600 font-bold" : "text-gray-600"}`; 
    label.textContent = day.getDate(); 
    cell.appendChild(label);
    
    if (load > 0) {
      const loadEl = document.createElement("div"); 
      loadEl.className = "calendar-load"; 
      const alpha = Math.min(load/600, .8); 
      loadEl.style.background = `linear-gradient(135deg, rgba(59,130,246,${alpha}) 0%, rgba(37,99,235,${alpha}) 100%)`; 
      cell.appendChild(loadEl);
      
      const val = document.createElement("div"); 
      val.className = "absolute bottom-1 right-2 text-xs font-bold text-blue-700"; 
      val.textContent = fmt(load); 
      cell.appendChild(val);
      
      // Adicionar tooltip
      cell.title = `${day.toLocaleDateString('pt-BR')}: ${fmt(load)} sRPE`;
    }
    
    grid.appendChild(cell);
  }
}

function toCSV(arr){ const header = ["date","name","duration","rpe"]; const rows = arr.map(s=>[s.date, s.name||"", s.duration||"", s.rpe||""]); return [header.join(","), ...rows.map(r=>r.join(","))].join("\n"); }
function fromCSV(text){
  const lines = text.trim().split(/\r?\n/); const head = lines.shift().split(",");
  const idx = { date: head.indexOf("date"), name: head.indexOf("name"), duration: head.indexOf("duration"), rpe: head.indexOf("rpe") };
  const out = []; lines.forEach(line => { const cols = line.split(","); const item = { id: crypto.randomUUID(), date: cols[idx.date]||"", name: cols[idx.name]||"", duration: Number(cols[idx.duration]||0), rpe: Number(cols[idx.rpe]||0) }; if(item.date) out.push(item); });
  return out;
}

function boot(){
  const sessions = loadLocal();
  const todayISO = toISODate(new Date());
  document.getElementById("dateInput").value = todayISO;
  document.getElementById("toInput").value = todayISO;
  document.getElementById("fromInput").value = toISODate(addDays(new Date(), -35));
  renderEntriesTable(sessions);
  renderKPIsAndChart(sessions, document.getElementById("fromInput").value, document.getElementById("toInput").value);
  renderCalendar(sessions);
}

 document.addEventListener("DOMContentLoaded", () => {
   // Aguardar Firebase carregar completamente
   setTimeout(() => {
     // Auto-connect com Firebase (h√≠brido)
     if (typeof FIREBASE_CONFIG !== 'undefined' && typeof firebase !== 'undefined') {
       connectFirebase();
     } else {
       console.warn("Configura√ß√£o do Firebase n√£o encontrada ou Firebase n√£o carregado.");
       document.getElementById("cloudStatus").textContent = "Configura√ß√£o necess√°ria";
       document.getElementById("cloudStatus").className = "small px-3 py-1 bg-red-100 text-red-800 rounded-full";
     }
   }, 1000); // Aguardar 1 segundo para Firebase carregar
   
   // Verificar resultado do redirecionamento do Google
   firebase.auth().getRedirectResult().then((result) => {
     if (result.user) {
       showNotification(`Bem-vindo, ${result.user.email || result.user.displayName}!`, "success");
     }
   }).catch((error) => {
     if (error.code !== 'auth/no-redirect-result') {
       console.error("Erro no redirecionamento:", error);
       showNotification("Erro no login: " + error.message, "error");
     }
   });
  document.getElementById("googleBtn").addEventListener("click", googleSignIn);
  document.getElementById("signOutBtn").addEventListener("click", signOut);
  document.getElementById("emailSignIn").addEventListener("click", () => emailSignIn(document.getElementById("emailInput").value, document.getElementById("passInput").value));
  document.getElementById("emailSignUp").addEventListener("click", () => emailSignUp(document.getElementById("emailInput").value, document.getElementById("passInput").value));
  document.getElementById("emailReset").addEventListener("click", () => emailReset(document.getElementById("emailInput").value));

  document.querySelectorAll(".chip[data-rpe]").forEach(el => el.addEventListener("click", ()=>{ document.getElementById("rpeInput").value = el.getAttribute("data-rpe"); }));

  document.getElementById("addBtn").addEventListener("click", async () => {
    const addBtn = document.getElementById("addBtn");
    const date = document.getElementById("dateInput").value;
    const name = document.getElementById("nameInput").value;
    const duration = Number(document.getElementById("durInput").value);
    const rpe = Number(document.getElementById("rpeInput").value);
    
    if(!date || !isFinite(duration) || !isFinite(rpe)) { 
      showNotification("Preencha data, dura√ß√£o e RPE.", "error");
      return; 
    }
    
    addLoadingState(addBtn);
    
    try {
      const sessions = loadLocal(); 
      sessions.push({ id: crypto.randomUUID(), date, name, duration, rpe }); 
      saveLocal(sessions);
      
      if(document.getElementById("autoSync").checked && fb.uid) { 
        try { 
          await pushToCloud(); 
          showNotification("Sess√£o adicionada e sincronizada!", "success");
        } catch(e){
          showNotification("Sess√£o adicionada localmente. Erro na sincroniza√ß√£o.", "error");
        }
      } else {
        showNotification("Sess√£o adicionada com sucesso!", "success");
      }
      
      document.getElementById("nameInput").value=""; 
      document.getElementById("durInput").value=""; 
      document.getElementById("rpeInput").value="";
    boot();
    } catch (error) {
      showNotification("Erro ao adicionar sess√£o.", "error");
    } finally {
      removeLoadingState(addBtn);
    }
  });

  document.getElementById("applyRangeBtn").addEventListener("click", () => { renderKPIsAndChart(loadLocal(), document.getElementById("fromInput").value, document.getElementById("toInput").value); });

  document.getElementById("seedBtn").addEventListener("click", () => {
    const seedBtn = document.getElementById("seedBtn");
    addLoadingState(seedBtn);
    
    try {
      const today = new Date(); 
      const start = new Date(today.getFullYear(), today.getMonth(), today.getDate()-41);
      const sess = []; 
      const names=["Run Intervals","Strength Lower","Bike Z2","Mobility","Small-sided","Tempo Run"];
      
      for(let i=0;i<42;i++){ 
        const d = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
      if(d.getDay()===0) continue;
      const dur = [30,40,45,50,60,75][Math.floor(Math.random()*6)];
      const rpe = [3,4,5,6,7][Math.floor(Math.random()*5)];
        sess.push({ 
          id: crypto.randomUUID(), 
          date: toISODate(d), 
          name: names[Math.floor(Math.random()*names.length)], 
          duration: dur, 
          rpe 
        });
      }
      
      saveLocal(sess); 
      boot();
      showNotification("Dados de demonstra√ß√£o carregados!", "success");
    } catch (error) {
      showNotification("Erro ao carregar dados de demonstra√ß√£o.", "error");
    } finally {
      removeLoadingState(seedBtn);
    }
  });
  document.getElementById("exportBtn").addEventListener("click", () => {
    try {
    const blob = new Blob([toCSV(loadLocal())], {type:"text/csv"});
      const a = document.createElement("a"); 
      a.href = URL.createObjectURL(blob); 
      a.download = `sessions_acwr_${new Date().toISOString().slice(0,10)}.csv`; 
      a.click();
      showNotification("Dados exportados com sucesso!", "success");
    } catch (error) {
      showNotification("Erro ao exportar dados.", "error");
    }
  });
  document.getElementById("importInput").addEventListener("change", (e) => {
    const file = e.target.files[0]; 
    if(!file) return;
    
    const reader = new FileReader(); 
    reader.onload = (ev) => { 
      try {
        const arr = fromCSV(ev.target.result); 
        const curr = loadLocal(); 
        saveLocal(curr.concat(arr)); 
        boot();
        showNotification(`${arr.length} sess√µes importadas com sucesso!`, "success");
      } catch (error) {
        showNotification("Erro ao importar arquivo CSV.", "error");
      }
    };
    reader.readAsText(file);
  });
  document.getElementById("clearBtn").addEventListener("click", () => { 
    if(confirm("‚ö†Ô∏è Tem certeza que deseja apagar todas as sess√µes do armazenamento local? Esta a√ß√£o n√£o pode ser desfeita.")) { 
      localStorage.removeItem(KEY); 
      boot();
      showNotification("Todos os dados foram removidos.", "info");
    } 
  });

  document.getElementById("prevMonth").addEventListener("click", ()=>{ calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1); renderCalendar(loadLocal()); });
  document.getElementById("nextMonth").addEventListener("click", ()=>{ calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1); renderCalendar(loadLocal()); });

  boot();
  
  // Atalhos de teclado
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Enter para adicionar sess√£o
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('addBtn').click();
    }
    
    // Ctrl/Cmd + S para salvar no cloud
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      if (fb.uid) {
        document.getElementById('cloudPush').click();
      }
    }
    
    // Ctrl/Cmd + L para carregar do cloud
    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
      e.preventDefault();
      if (fb.uid) {
        document.getElementById('cloudPull').click();
      }
    }
    
    // Escape para limpar formul√°rio
    if (e.key === 'Escape') {
      document.getElementById('nameInput').value = '';
      document.getElementById('durInput').value = '';
      document.getElementById('rpeInput').value = '';
      document.getElementById('nameInput').focus();
    }
  });
  
  // Foco autom√°tico no nome da sess√£o
  document.getElementById('nameInput').focus();
  
  // Auto-complete para data (hoje)
  if (!document.getElementById('dateInput').value) {
    document.getElementById('dateInput').value = toISODate(new Date());
  }
});
</script>
</body>
</html>
