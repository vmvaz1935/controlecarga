<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teste dos Gráficos - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">🧪 Teste dos Gráficos do Dashboard</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Gráfico de Linha - Evolução Temporal -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">📈 Evolução Temporal</h3>
        <div class="chart-container">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>
      
      <!-- Gráfico de Barras - Distribuição RPE -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Distribuição RPE</h3>
        <div class="chart-container">
          <canvas id="rpeChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Gráfico de Pizza - Tipos de Atividade -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">🥧 Tipos de Atividade</h3>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
      
      <!-- Gráfico de Área - Carga Semanal -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">📅 Carga Semanal</h3>
        <div class="chart-container">
          <canvas id="weeklyLoadChart"></canvas>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">🎮 Controles de Teste</h3>
      <div class="flex gap-4 flex-wrap">
        <button onclick="testWithSampleData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
          📊 Dados de Exemplo
        </button>
        <button onclick="testWithEmptyData()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
          🚫 Dados Vazios
        </button>
        <button onclick="testWithRealData()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
          🔗 Dados Reais (localStorage)
        </button>
        <button onclick="clearCharts()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
          🗑️ Limpar Gráficos
        </button>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow mt-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">📝 Logs de Debug</h3>
      <div id="debugLog" class="bg-gray-100 p-4 rounded text-sm font-mono h-64 overflow-y-auto">
        <div class="text-gray-500">Logs aparecerão aqui...</div>
      </div>
    </div>
  </div>

  <script>
    let charts = {};
    
    // Função para log
    function log(message) {
      const debugLog = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.innerHTML += `<div class="mb-2"><span class="text-gray-500">[${timestamp}]</span> ${message}</div>`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(message);
    }
    
    // Verificar se Chart.js está disponível
    function checkChartJS() {
      if (typeof Chart === 'undefined') {
        log('❌ Chart.js não está carregado!');
        return false;
      }
      log('✅ Chart.js carregado com sucesso!');
      return true;
    }
    
    // Inicializar gráficos vazios
    function initializeEmptyCharts() {
      log('🎨 Inicializando gráficos vazios...');
      
      try {
        const chartIds = ['timelineChart', 'rpeChart', 'activityChart', 'weeklyLoadChart'];
        
        chartIds.forEach(id => {
          const canvas = document.getElementById(id);
          if (canvas) {
            const ctx = canvas.getContext('2d');
            charts[id] = new Chart(ctx, {
              type: 'line',
              data: { labels: [], datasets: [] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: { enabled: false }
                }
              }
            });
          }
        });
        
        log('✅ Gráficos vazios inicializados com sucesso!');
      } catch (error) {
        log('❌ Erro ao inicializar gráficos vazios: ' + error.message);
      }
    }
    
    // Testar com dados de exemplo
    function testWithSampleData() {
      log('🧪 Testando com dados de exemplo...');
      
      const sampleData = [
        { date: '2024-12-01', name: 'Corrida', duration: 45, rpe: 7 },
        { date: '2024-12-02', name: 'Musculação', duration: 60, rpe: 8 },
        { date: '2024-12-03', name: 'Natação', duration: 30, rpe: 6 },
        { date: '2024-12-04', name: 'Corrida', duration: 50, rpe: 7 },
        { date: '2024-12-05', name: 'Yoga', duration: 45, rpe: 4 },
        { date: '2024-12-06', name: 'Ciclismo', duration: 90, rpe: 8 },
        { date: '2024-12-07', name: 'Descanso', duration: 0, rpe: 1 }
      ];
      
      updateCharts(sampleData);
    }
    
    // Testar com dados vazios
    function testWithEmptyData() {
      log('🚫 Testando com dados vazios...');
      updateCharts([]);
    }
    
    // Testar com dados reais do localStorage
    function testWithRealData() {
      log('🔗 Testando com dados reais do localStorage...');
      
      try {
        const sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
        log(`📊 Encontradas ${sessions.length} sessões no localStorage`);
        
        if (sessions.length > 0) {
          updateCharts(sessions);
        } else {
          log('⚠️ Nenhuma sessão encontrada no localStorage');
          updateCharts([]);
        }
      } catch (error) {
        log('❌ Erro ao ler dados do localStorage: ' + error.message);
      }
    }
    
    // Limpar gráficos
    function clearCharts() {
      log('🗑️ Limpando gráficos...');
      
      Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
          chart.destroy();
        }
      });
      
      charts = {};
      initializeEmptyCharts();
      log('✅ Gráficos limpos e reinicializados!');
    }
    
    // Atualizar gráficos
    function updateCharts(data) {
      log(`🔄 Atualizando gráficos com ${data.length} sessões...`);
      
      try {
        // Timeline Chart
        updateTimelineChart(data);
        
        // RPE Chart
        updateRPEChart(data);
        
        // Activity Chart
        updateActivityChart(data);
        
        // Weekly Load Chart
        updateWeeklyLoadChart(data);
        
        log('✅ Todos os gráficos atualizados com sucesso!');
      } catch (error) {
        log('❌ Erro ao atualizar gráficos: ' + error.message);
      }
    }
    
    // Atualizar gráfico de evolução temporal
    function updateTimelineChart(data) {
      log('📈 Atualizando gráfico de evolução temporal...');
      
      const canvas = document.getElementById('timelineChart');
      if (!canvas) {
        log('❌ Canvas timelineChart não encontrado!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        log('❌ Contexto 2D não disponível!');
        return;
      }
      
      // Destruir gráfico existente
      if (charts.timelineChart) {
        charts.timelineChart.destroy();
      }
      
      if (data.length === 0) {
        log('⚠️ Nenhum dado para exibir no gráfico de evolução temporal');
        charts.timelineChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          }
        });
        return;
      }
      
      const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
      log(`📅 Dados ordenados por data: ${sortedData.length} sessões`);
      
      charts.timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedData.map(d => new Date(d.date).toLocaleDateString('pt-BR')),
          datasets: [{
            label: 'RPE',
            data: sortedData.map(d => d.rpe),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
          }, {
            label: 'Duração (min)',
            data: sortedData.map(d => d.duration),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'RPE' },
              beginAtZero: true,
              max: 10
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Duração (min)' },
              grid: { drawOnChartArea: false },
              beginAtZero: true
            },
            x: {
              title: { display: true, text: 'Data' }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                afterBody: function(context) {
                  const index = context[0].dataIndex;
                  const session = sortedData[index];
                  return `Atividade: ${session.name}`;
                }
              }
            }
          }
        }
      });
      
      log('✅ Gráfico de evolução temporal criado com sucesso!');
    }
    
    // Atualizar gráfico de distribuição RPE
    function updateRPEChart(data) {
      log('📊 Atualizando gráfico de distribuição RPE...');
      
      const canvas = document.getElementById('rpeChart');
      if (!canvas) {
        log('❌ Canvas rpeChart não encontrado!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        log('❌ Contexto 2D não disponível!');
        return;
      }
      
      // Destruir gráfico existente
      if (charts.rpeChart) {
        charts.rpeChart.destroy();
      }
      
      if (data.length === 0) {
        log('⚠️ Nenhum dado para exibir no gráfico de distribuição RPE');
        charts.rpeChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          }
        });
        return;
      }
      
      const rpeCounts = {};
      data.forEach(session => {
        rpeCounts[session.rpe] = (rpeCounts[session.rpe] || 0) + 1;
      });
      
      log(`📊 Contagem RPE: ${JSON.stringify(rpeCounts)}`);
      
      charts.rpeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(rpeCounts).sort((a, b) => a - b),
          datasets: [{
            label: 'Sessões',
            data: Object.keys(rpeCounts).sort((a, b) => a - b).map(rpe => rpeCounts[rpe]),
            backgroundColor: [
              '#ef4444', '#f97316', '#f59e0b', '#eab308', 
              '#84cc16', '#22c55e', '#10b981', '#14b8a6'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y} sessões com RPE ${context.parsed.x}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Número de Sessões' }
            },
            x: {
              title: { display: true, text: 'RPE' }
            }
          }
        }
      });
      
      log('✅ Gráfico de distribuição RPE criado com sucesso!');
    }
    
    // Atualizar gráfico de tipos de atividade
    function updateActivityChart(data) {
      log('🥧 Atualizando gráfico de tipos de atividade...');
      
      const canvas = document.getElementById('activityChart');
      if (!canvas) {
        log('❌ Canvas activityChart não encontrado!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        log('❌ Contexto 2D não disponível!');
        return;
      }
      
      // Destruir gráfico existente
      if (charts.activityChart) {
        charts.activityChart.destroy();
      }
      
      if (data.length === 0) {
        log('⚠️ Nenhum dado para exibir no gráfico de tipos de atividade');
        charts.activityChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          }
        });
        return;
      }
      
      const activityCounts = {};
      data.forEach(session => {
        activityCounts[session.name] = (activityCounts[session.name] || 0) + 1;
      });
      
      log(`🥧 Contagem de atividades: ${JSON.stringify(activityCounts)}`);
      
      const colors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
        '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'
      ];
      
      charts.activityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(activityCounts),
          datasets: [{
            data: Object.values(activityCounts),
            backgroundColor: colors.slice(0, Object.keys(activityCounts).length),
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: ${context.parsed} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      log('✅ Gráfico de tipos de atividade criado com sucesso!');
    }
    
    // Atualizar gráfico de carga semanal
    function updateWeeklyLoadChart(data) {
      log('📅 Atualizando gráfico de carga semanal...');
      
      const canvas = document.getElementById('weeklyLoadChart');
      if (!canvas) {
        log('❌ Canvas weeklyLoadChart não encontrado!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        log('❌ Contexto 2D não disponível!');
        return;
      }
      
      // Destruir gráfico existente
      if (charts.weeklyLoadChart) {
        charts.weeklyLoadChart.destroy();
      }
      
      if (data.length === 0) {
        log('⚠️ Nenhum dado para exibir no gráfico de carga semanal');
        charts.weeklyLoadChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          }
        });
        return;
      }
      
      // Agrupar por semana
      const weeklyData = {};
      data.forEach(session => {
        const date = new Date(session.date);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeklyData[weekKey]) {
          weeklyData[weekKey] = { load: 0, sessions: 0 };
        }
        weeklyData[weekKey].load += session.duration * session.rpe;
        weeklyData[weekKey].sessions += 1;
      });
      
      const sortedWeeks = Object.keys(weeklyData).sort();
      log(`📅 Dados semanais: ${JSON.stringify(weeklyData)}`);
      
      charts.weeklyLoadChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedWeeks.map(week => {
            const date = new Date(week);
            return `Semana ${date.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' })}`;
          }),
          datasets: [{
            label: 'Carga Semanal',
            data: sortedWeeks.map(week => weeklyData[week].load),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                afterBody: function(context) {
                  const week = sortedWeeks[context[0].dataIndex];
                  return `Sessões: ${weeklyData[week].sessions}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Carga Total' }
            }
          }
        }
      });
      
      log('✅ Gráfico de carga semanal criado com sucesso!');
    }
    
    // Inicializar quando a página carregar
    document.addEventListener('DOMContentLoaded', () => {
      log('🚀 Página de teste carregada!');
      
      if (!checkChartJS()) {
        log('❌ Chart.js não está disponível. Verifique se o CDN está funcionando.');
        return;
      }
      
      initializeEmptyCharts();
      log('✅ Teste inicializado com sucesso!');
    });
  </script>
</body>
</html>